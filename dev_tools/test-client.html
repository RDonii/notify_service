<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>NotifyService SSE Tester</title>
  <style>
    body { font-family: system-ui, sans-serif; margin: 20px; }
    label { display:block; margin-top:8px }
    input, button, textarea { font-family: inherit; }
    #log { white-space: pre-wrap; border: 1px solid #ccc; padding: 10px; height: 420px; overflow: auto; background:#fafafa }
    .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap }
    .small { font-size: 12px; color:#555 }
  </style>
</head>
<body>
  <h1>NotifyService SSE Tester</h1>

  <div class="row">
    <label>Stream URL (absolute)</label>
    <input id="url" size="70" value="http://localhost:8000/api/v1/external/notify/stream">
  </div>

  <div class="row">
    <label>JWT token</label>
    <input id="token" size="70" placeholder="paste JWT here">
  </div>

  <div class="row">
    <label>Custom event types (comma-separated)</label>
    <input id="types" size="70" placeholder="e.g. test,report_ready,progress">
  </div>

  <div class="row" style="margin-top:10px">
    <button id="connectBtn">Connect</button>
    <button id="disconnectBtn">Disconnect</button>
    <span class="small" id="status"></span>
  </div>

  <h3>Events</h3>
  <div id="log"></div>

  <script>
    let es = null;

    function log(msg) {
      const el = document.getElementById('log');
      el.textContent += msg + '\n';
      el.scrollTop = el.scrollHeight;
    }
    function setStatus(s) {
      document.getElementById('status').textContent = s;
    }

    function connect() {
      const base = document.getElementById('url').value.trim();
      const token = document.getElementById('token').value.trim();
      const typesRaw = document.getElementById('types').value.trim();

      if (!base) return alert('Enter stream URL');
      if (!token) return alert('Enter JWT token');

      if (es) es.close();

      // Cache-buster avoids any intermediary caching issues
      const url = `${base}?token=${encodeURIComponent(token)}&t=${Date.now()}`;
      es = new EventSource(url);

      log(`Connecting to ${url}`);
      setStatus('connecting…');

      es.onopen = () => {
        log(`✅ onopen (readyState=${es.readyState})`);
        setStatus('open');
      };

      es.onerror = (e) => {
        log(`❌ onerror (readyState=${es.readyState})`);
        // Most browsers auto-reconnect; keep the connection.
        setStatus('error (auto-retrying if supported)');
      };

      // Default messages (no custom "event:" name)
      es.onmessage = (ev) => {
        log(`📨 [message] ${ev.data}`);
      };

      // Built-in "ready" from server (optional)
      es.addEventListener('ready', (ev) => {
        log(`🔔 [ready] ${ev.data}`);
      });

      // Dynamically register custom event listeners
      if (typesRaw) {
        typesRaw.split(',').map(s => s.trim()).filter(Boolean).forEach((t) => {
          es.addEventListener(t, (ev) => {
            log(`🧷 [${t}] ${ev.data}`);
          });
        });
      }
    }

    document.getElementById('connectBtn').onclick = connect;
    document.getElementById('disconnectBtn').onclick = () => {
      if (es) {
        es.close();
        setStatus('closed');
        log('🔒 stream closed');
      }
    };
  </script>
</body>
</html>